<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CueUp - Debug Tools</title>
    <link rel="stylesheet" href="startpage.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <style>
        body {
            color: #fff;
        }
        
        .debug-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .debug-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .debug-header h1 {
            color: #aa00ff;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            border-left: 4px solid #aa00ff;
        }
        
        .debug-section h2 {
            color: #aa00ff;
            margin-top: 0;
        }
        
        .test-button {
            background: linear-gradient(135deg, #aa00ff, #cc44ff);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .test-button:hover {
            background: linear-gradient(135deg, #cc44ff, #aa00ff);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(170, 0, 255, 0.4);
        }
        
        .url-input {
            width: 100%;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: monospace;
        }
        
        .result-container {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            overflow-x: auto;
            max-height: 300px;
            font-family: monospace;
            white-space: pre-wrap;
            color: #ddd;
        }
        
        .success {
            color: #4caf50;
            border-left: 4px solid #4caf50;
        }
        
        .error {
            color: #f44336;
            border-left: 4px solid #f44336;
        }
        
        .warning {
            color: #ff9800;
            border-left: 4px solid #ff9800;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        table, th, td {
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        th, td {
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: rgba(170, 0, 255, 0.2);
        }
        
        tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .method-selector {
            margin-bottom: 10px;
        }
        
        .method-selector label {
            margin-right: 15px;
            cursor: pointer;
        }
        
        .headers-input {
            width: 100%;
            height: 100px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: monospace;
            padding: 10px;
        }
        
        .body-input {
            width: 100%;
            height: 150px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: monospace;
            padding: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-2xx {
            background-color: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }
        
        .status-3xx {
            background-color: rgba(255, 152, 0, 0.3);
            color: #ff9800;
        }
        
        .status-4xx, .status-5xx {
            background-color: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }
        
        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        

        
        .status-details {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .status-details p {
            margin: 8px 0;
            color: #ddd;
        }
        
        .problem-item {
            background-color: rgba(255, 152, 0, 0.05);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            border-left: 3px solid #ff9800;
            font-size: 0.9rem;
        }
        
        .problem-item h3 {
            color: #ff9800;
            margin-top: 0;
        }
        
        .problem-item ul {
            margin: 10px 0 0 20px;
        }
        
        .problem-item li {
            margin: 5px 0;
        }
        
        .contact-link {
            color: #aa00ff;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        
        .contact-link:hover {
            color: #cc44ff;
            text-decoration: underline;
        }
        
        .problem-actions {
            margin-top: 10px;
        }
        
        .traffic-light {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .traffic-light.green {
            background-color: #4caf50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.6);
        }
        
        .traffic-light.yellow {
            background-color: #ff9800;
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.6);
        }
        
        .traffic-light.red {
            background-color: #f44336;
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.6);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
        }
        
        .status-text {
            flex: 1;
        }
        

        
        .advanced-tool {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        
        .quick-tests {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        
        .quick-test {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            font-size: 0.9rem;
            padding: 8px 16px;
        }
        
        .quick-test:hover {
            background: linear-gradient(135deg, #21CBF3, #2196F3);
        }
        
        .route-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }
        
        .route-item {
            background-color: rgba(255, 255, 255, 0.1);
            margin-bottom: 5px;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
        }
        
        .route-item:hover {
            background-color: rgba(170, 0, 255, 0.2);
        }
        
        .route-method {
            font-weight: bold;
            margin-right: 10px;
            min-width: 60px;
            text-align: center;
            padding: 3px 8px;
            border-radius: 3px;
            color: white;
        }
        
        .method-get {
            background-color: #2196F3;
        }
        
        .method-post {
            background-color: #4CAF50;
        }
        
        .method-put {
            background-color: #FF9800;
        }
        
        .method-delete {
            background-color: #F44336;
        }
        
        /* Footer Styles - exakt wie startpage.css */
        .footer {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.95), rgba(40, 40, 40, 0.9)) !important;
            margin-top: 80px;
            padding: 50px 0 20px;
            border-top: 1px solid rgba(170, 0, 255, 0.2);
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
        }
        
        .footer-section h3 {
            color: #aa00ff;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .footer-section p {
            color: #ccc;
            line-height: 1.6;
            font-size: 0.9rem;
        }
        
        .footer-links {
            list-style: none;
            padding: 0;
        }
        
        .footer-links li {
            margin-bottom: 10px;
        }
        
        .footer-links a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .footer-links a:hover {
            color: #aa00ff;
        }
        
        .footer-bottom {
            text-align: center;
            padding-top: 30px;
            margin-top: 40px;
            border-top: 1px solid rgba(170, 0, 255, 0.1);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .footer-bottom p {
            color: #999;
            font-size: 0.9rem;
        }
        
        .footer-bottom a {
            color: #aa00ff;
            text-decoration: none;
        }
        
        .footer-bottom a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <header>
        <a href="startpage" class="mainLogoLink">
            <h1 class="mainlogo">Cueup</h1>
        </a>
        <div style="display: flex; align-items: center; margin-right: 20px;">
            <label class="burger" for="burger">
                <input type="checkbox" id="burger" />
                <span></span>
                <span></span>
                <span></span>
            </label>
        </div>
    </header>

    <div class="sidebar" id="sidebar">
        <nav>
            <ul id="navigationMenu">
                <li><a href="startpage">Startseite</a></li>
                <li><a href="free">Login</a></li>
                <li><a href="debug">Debug</a></li>
            </ul>
        </nav>
    </div>

    <main>
        <div class="debug-container">
            <div class="debug-header">
                <h1>CueUp Server Status</h1>
                <p>√úberpr√ºfen Sie den aktuellen Status des CueUp Servers</p>
            </div>

            <div class="debug-section">
                <h2>Server-Verbindung</h2>
                <div id="statusDetails" class="status-details">
                    <div id="serverInfo">
                        <div class="status-indicator">
                            <div id="statusLight" class="traffic-light red"></div>
                            <div class="status-text">
                                <p><strong>Status:</strong> <span id="statusText">Wird gepr√ºft...</span></p>
                                <p><strong>Zuletzt gepr√ºft:</strong> <span id="lastCheck">Nie</span></p>
                                <p><strong>Antwortzeit:</strong> <span id="responseTime">--</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="checkConnection" class="test-button">
                    Status aktualisieren
                    <span id="connectionSpinner" class="spinner"></span>
                </button>
            </div>

            <div class="debug-section" id="problemSection" style="display: none;">
                <h2 style="font-size: 1.2rem;">‚ö†Ô∏è Probleme erkannt</h2>
                <div id="problemSolutions">
                    <div class="problem-item">
                        <h3>üî¥ Server nicht erreichbar</h3>
                        <p>Es gibt ein Problem mit dem CueUp Server.</p>
                        <div class="problem-actions">
                            <p><strong>Was Sie tun k√∂nnen:</strong></p>
                            <ul>
                                <li>üîÑ Warten Sie 2-3 Minuten und versuchen Sie es erneut</li>
                                <li>üåê Pr√ºfen Sie Ihre Internetverbindung</li>
                                <li>üìß <a href="contact" class="contact-link">Problem melden ‚Üí Kontakt</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="problem-item" id="slowServerWarning" style="display: none;">
                        <h3>üü° Server reagiert langsam</h3>
                        <p>Der Server funktioniert, braucht aber l√§nger als √ºblich.</p>
                        <div class="problem-actions">
                            <p><strong>M√∂gliche Ursachen:</strong></p>
                            <ul>
                                <li>‚è≥ Server ist √ºberlastet</li>
                                <li>üåê Ihre Internetverbindung ist langsam</li>
                                <li>üìß Bei dauerhaften Problemen: <a href="contact" class="contact-link">Kontakt</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="debug-section" id="advancedSection">
                <h2>üîß Erweiterte Optionen</h2>
                <button id="toggleAdvanced" class="test-button">
                    Erweiterte Tools anzeigen
                </button>
                <div id="advancedTools" style="display: none;">
                    <div class="advanced-tool">
                        <h3>Schnelltest Routen</h3>
                        <div class="quick-tests">
                            <button class="test-button quick-test" data-url="https://novel-willyt-veqro-a29cd625.koyeb.app/auth/status">Login-System testen</button>
                            <button class="test-button quick-test" data-url="https://novel-willyt-veqro-a29cd625.koyeb.app/api/events">Event-System testen</button>
                        </div>
                        <div id="quickTestResult" class="result-container" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>CueUp</h3>
                <p>Die professionelle L√∂sung f√ºr DJ Event-Management und Musikwunsch-Verwaltung mit nahtloser Spotify-Integration.</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul class="footer-links">
                    <li><a href="startpage">Startseite</a></li>
                    <li><a href="createevent">Event erstellen</a></li>
                    <li><a href="myEvents">Meine Events</a></li>
                    <li><a href="contact">Kontakt</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>CueUp | <a href="debug">Debug Tools</a> | <a href="#" id="adminFooterLink">System Administration</a></p>
        </div>
    </footer>
        
        <!-- Admin Modal -->
        <div id="adminModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #aa00ff; margin: 0;">üîß CueUp Admin Panel</h2>
                    <button id="closeAdmin" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">‚úï</button>
                </div>
                
                <div id="adminAuth" style="text-align: center;">
                    <p style="color: #ddd; margin-bottom: 20px;">Admin-Passwort eingeben:</p>
                    <input type="password" id="adminPassword" placeholder="Passwort" style="padding: 10px; width: 200px; background: rgba(255,255,255,0.1); color: white; border: 1px solid #aa00ff; border-radius: 5px; text-align: center;">
                    <br><br>
                    <button id="adminLogin" class="test-button">Anmelden</button>
                    <div id="adminError" style="color: #f44336; margin-top: 10px; display: none;">Falsches Passwort!</div>
                </div>
                
                <div id="adminContent" style="display: none;">
                    <div class="admin-section">
                        <h3 style="color: #aa00ff;">üìä Server Statistiken</h3>
                        <div id="serverStats" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 5px; margin: 10px 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <strong>Uptime:</strong> <span id="uptime">Wird geladen...</span><br>
                                    <strong>Letzte Pr√ºfung:</strong> <span id="adminLastCheck">--</span><br>
                                    <strong>Antwortzeit:</strong> <span id="adminResponseTime">--</span>
                                </div>
                                <div>
                                    <strong>Status-Verlauf:</strong><br>
                                    <div id="statusHistory" style="font-size: 0.9em; color: #ccc;">
                                        Verlaufsdaten werden gesammelt...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="admin-section">
                        <h3 style="color: #aa00ff;">üîß Wartung & Tools</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin: 15px 0;">
                            <button class="test-button" id="clearCache">Cache leeren</button>
                            <button class="test-button" id="testAllEndpoints">Alle Endpunkte testen</button>
                            <button class="test-button" id="downloadLogs">Logs herunterladen</button>
                            <button class="test-button" id="viewServerLogs">Server Logs anzeigen</button>
                            <button class="test-button" id="refreshServerLogs">Logs aktualisieren</button>
                        </div>
                        <div id="maintenanceResult" style="background: #1e1e1e; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; display: none;"></div>
                    </div>
                    
                    <div class="admin-section">
                        <h3 style="color: #aa00ff;">üìã Server Logs</h3>
                        <div style="margin: 15px 0;">
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <select id="logLevel" style="padding: 5px; background: rgba(255,255,255,0.1); color: white; border: 1px solid #aa00ff; border-radius: 3px;">
                                    <option value="all">Alle Logs</option>
                                    <option value="error">Nur Fehler</option>
                                    <option value="warning">Warnungen</option>
                                    <option value="info">Info</option>
                                    <option value="debug">Debug</option>
                                </select>
                                <input type="number" id="logLimit" placeholder="Anzahl (100)" min="10" max="1000" value="100" style="width: 100px; padding: 5px; background: rgba(255,255,255,0.1); color: white; border: 1px solid #aa00ff; border-radius: 3px;">
                                <button class="test-button" id="loadLogs">Logs laden</button>
                            </div>
                        </div>
                        <div id="serverLogsContainer" style="background: #0a0a0a; border: 1px solid #333; border-radius: 5px; padding: 15px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; color: #ddd;">
                            <div style="color: #888; text-align: center; padding: 20px;">
                                Klicken Sie auf "Logs laden" um Server-Logs anzuzeigen
                            </div>
                        </div>
                    </div>
                    
                    <div class="admin-section">
                        <h3 style="color: #aa00ff;">üìà Website Analytics</h3>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 5px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <strong>Besucher heute:</strong> <span id="visitorsToday">--</span><br>
                                    <strong>Aktive Sessions:</strong> <span id="activeSessions">--</span><br>
                                    <strong>Spotify Logins:</strong> <span id="spotifyLogins">--</span>
                                </div>
                                <div>
                                    <strong>Events erstellt:</strong> <span id="eventsCreated">--</span><br>
                                    <strong>Song Requests:</strong> <span id="songRequests">--</span><br>
                                    <strong>Fehlermeldungen:</strong> <span id="errorCount">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="admin-section">
                        <h3 style="color: #aa00ff;">‚ö° Quick Actions</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="test-button" id="restartServer">Server neustarten</button>
                            <button class="test-button" id="backupData">Daten sichern</button>
                            <button class="test-button" id="viewErrors">Fehler anzeigen</button>
                            <button class="test-button" id="systemHealth">System-Check</button>
                        </div>
                        <div id="quickActionResult" style="background: #1e1e1e; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; display: none; margin-top: 15px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Burger Menu Toggle
        document.getElementById('burger').addEventListener('change', function() {
            document.getElementById('sidebar').classList.toggle('active');
        });

        // Sofort das Standard-Men√º anzeigen
        function showDefaultMenu() {
            const navigationMenu = document.getElementById('navigationMenu');
            navigationMenu.innerHTML = `
                <li><a href="startpage">Startseite</a></li>
                <li><a href="contact">Kontakt</a></li>
                <li><a href="debug">Debug</a></li>
                <li><a href="free">Einloggen</a></li>
            `;
        }

        // Sofort Standard-Men√º zeigen
        showDefaultMenu();
        
        // Dynamisches Men√º basierend auf Login-Status
        async function updateNavigation() {
            const navigationMenu = document.getElementById('navigationMenu');
            
            try {
                // Timeout f√ºr die Anfrage setzen
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                // Pr√ºfe Login-Status
                const response = await fetch('https://novel-willyt-veqro-a29cd625.koyeb.app/auth/status', {
                    credentials: 'include',
                    signal: controller.signal
                }).catch(err => {
                    if (err.name === 'AbortError') {
                        console.log('Timeout bei Auth-Status-Abfrage, behalte Standard-Men√º');
                        return null;
                    }
                    throw err;
                });
                
                clearTimeout(timeoutId);
                
                // Wenn kein Response, dann bei Standard-Men√º bleiben
                if (!response) return;
                
                const data = await response.json();
                const isLoggedIn = data.isAuthenticated;
                
                // Basis-Men√ºpunkte (immer sichtbar)
                const baseMenuItems = [
                    { text: 'Startseite', href: 'startpage' },
                    { text: 'Kontakt', href: 'contact' },
                    { text: 'Debug', href: 'debug' }
                ];
                
                let menuItems = [];
                
                if (isLoggedIn) {
                    // Angemeldeter Benutzer
                    menuItems = [
                        ...baseMenuItems,
                        { text: 'Event erstellen', href: 'createevent' },
                        { text: 'Meine Events', href: 'myEvents' },
                        { text: 'Profil', href: 'profile' },
                        { text: 'Ausloggen', href: '#', onclick: 'logout()' }
                    ];
                } else {
                    // Nicht angemeldeter Benutzer
                    menuItems = [
                        ...baseMenuItems,
                        { text: 'Einloggen', href: 'free' }
                    ];
                }
                
                // Men√º aufbauen
                navigationMenu.innerHTML = menuItems.map(item => {
                    if (item.onclick) {
                        return `<li><a href="${item.href}" onclick="${item.onclick}">${item.text}</a></li>`;
                    } else {
                        return `<li><a href="${item.href}">${item.text}</a></li>`;
                    }
                }).join('');
                
            } catch (error) {
                console.log('Auth check failed, showing guest menu');
                // Bei Fehler: Gast-Men√º anzeigen
                navigationMenu.innerHTML = `
                    <li><a href="startpage">Startseite</a></li>
                    <li><a href="contact">Kontakt</a></li>
                    <li><a href="debug">Debug</a></li>
                    <li><a href="free">Einloggen</a></li>
                `;
            }
        }

        function logout() {
            fetch('https://novel-willyt-veqro-a29cd625.koyeb.app/logout', {
                method: 'POST',
                credentials: 'include'
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = 'free';
                }
            })
            .catch(error => {
                console.error('Logout failed:', error);
                // Fallback: Zur Login-Seite weiterleiten
                window.location.href = 'free';
            });
        }

        // Funktion zum Formatieren von JSON mit Syntax-Highlighting
        function formatJSON(json) {
            if (typeof json !== 'string') {
                json = JSON.stringify(json, null, 2);
            }
            
            try {
                // Versuchen, den JSON-String zu parsen
                const parsedJSON = JSON.parse(json);
                json = JSON.stringify(parsedJSON, null, 2);
            } catch(e) {
                // Bei Fehler den String unver√§ndert zur√ºckgeben
                return json;
            }
            
            // Einfache Syntax-Highlighting
            return json
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function(match) {
                    let cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                            match = '<span style="color: #f8c555;">' + match + '</span>';
                        } else {
                            cls = 'string';
                            match = '<span style="color: #7ec699;">' + match + '</span>';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                        match = '<span style="color: #569cd6;">' + match + '</span>';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                        match = '<span style="color: #569cd6;">' + match + '</span>';
                    } else {
                        match = '<span style="color: #b5cea8;">' + match + '</span>';
                    }
                    return match;
                });
        }

        // Backend-Verbindungsstatus pr√ºfen
        document.getElementById('checkConnection').addEventListener('click', async function() {
            const spinner = document.getElementById('connectionSpinner');
            const responseTimeElement = document.getElementById('responseTime');
            const lastCheckElement = document.getElementById('lastCheck');
            const problemSection = document.getElementById('problemSection');
            
            spinner.style.display = 'inline-block';
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                
                const startTime = performance.now();
                const response = await fetch('https://novel-willyt-veqro-a29cd625.koyeb.app/auth/status', {
                    method: 'GET',
                    credentials: 'include',
                    signal: controller.signal
                });
                const endTime = performance.now();
                const latency = Math.round(endTime - startTime);
                
                clearTimeout(timeoutId);
                
                // Erfolgreiche Verbindung
                responseTimeElement.textContent = `${latency}ms`;
                lastCheckElement.textContent = new Date().toLocaleTimeString('de-DE');
                
                // Ampel auf Gr√ºn
                document.getElementById('statusLight').className = 'traffic-light green';
                document.getElementById('statusText').textContent = 'Online';
                problemSection.style.display = 'none';
                
                // Warnung bei langsamer Antwortzeit
                if (latency > 2000) {
                    document.getElementById('statusLight').className = 'traffic-light yellow';
                    document.getElementById('statusText').textContent = 'Langsam';
                    // Probleme nur bei sehr langsamen Verbindungen anzeigen
                    if (latency > 5000) {
                        document.getElementById('slowServerWarning').style.display = 'block';
                        problemSection.style.display = 'block';
                    }
                    addToStatusHistory('Langsam', latency);
                } else {
                    addToStatusHistory('Online', latency);
                }
                
            } catch (error) {
                responseTimeElement.textContent = 'Timeout';
                lastCheckElement.textContent = new Date().toLocaleTimeString('de-DE');
                
                // Ampel auf Rot
                document.getElementById('statusLight').className = 'traffic-light red';
                document.getElementById('statusText').textContent = 'Offline';
                problemSection.style.display = 'block';
                
                if (error.name === 'AbortError') {
                    connectionStatus.innerHTML = '‚ùå Server Timeout';
                    addToStatusHistory('Timeout', 'N/A');
                } else {
                    connectionStatus.innerHTML = '‚ùå Server offline';
                    addToStatusHistory('Offline', 'N/A');
                }
            } finally {
                spinner.style.display = 'none';
            }
        });
        
        // Erweiterte Tools Toggle
        document.getElementById('toggleAdvanced').addEventListener('click', function() {
            const advancedTools = document.getElementById('advancedTools');
            const button = this;
            
            if (advancedTools.style.display === 'none') {
                advancedTools.style.display = 'block';
                button.textContent = 'Erweiterte Tools verstecken';
            } else {
                advancedTools.style.display = 'none';
                button.textContent = 'Erweiterte Tools anzeigen';
            }
        });
        
        // Schnelltests
        document.querySelectorAll('.quick-test').forEach(button => {
            button.addEventListener('click', async function() {
                const url = this.getAttribute('data-url');
                const resultContainer = document.getElementById('quickTestResult');
                
                resultContainer.style.display = 'block';
                resultContainer.innerHTML = `Testing ${url}...`;
                
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        credentials: 'include',
                        signal: AbortSignal.timeout(5000)
                    });
                    
                    const statusText = response.ok ? '‚úÖ Funktioniert' : '‚ùå Fehler';
                    resultContainer.innerHTML = `${url}: ${statusText} (${response.status})`;
                } catch (error) {
                    resultContainer.innerHTML = `${url}: ‚ùå Nicht erreichbar`;
                }
            });
        });

        
        // Headers formatieren
        function formatHeaders(headers) {
            const headersObj = {};
            headers.forEach((value, key) => {
                headersObj[key] = value;
            });
            return formatJSON(headersObj);
        }
        
        // Admin Panel Funktionalit√§t
        let adminLoggedIn = false;
        let statusHistory = [];
        
        // Admin-Zugriff √ºber Footer
        document.getElementById('adminFooterLink').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('adminModal').style.display = 'block';
        });
        
        // Admin Modal schlie√üen
        document.getElementById('closeAdmin').addEventListener('click', function() {
            document.getElementById('adminModal').style.display = 'none';
        });
        
        // Admin Login
        document.getElementById('adminLogin').addEventListener('click', async function() {
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('adminError');
            const loginButton = this;
            
            if (!password) {
                errorDiv.textContent = 'Bitte Passwort eingeben';
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 3000);
                return;
            }
            
            loginButton.disabled = true;
            loginButton.textContent = 'Pr√ºfe...';
            
            try {
                const response = await fetch('https://novel-willyt-veqro-a29cd625.koyeb.app/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ password: password })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    adminLoggedIn = true;
                    // Token speichern f√ºr weitere Admin-Requests
                    if (result.token) {
                        sessionStorage.setItem('adminToken', result.token);
                    }
                    document.getElementById('adminAuth').style.display = 'none';
                    document.getElementById('adminContent').style.display = 'block';
                    loadAdminData();
                } else {
                    errorDiv.textContent = result.message || 'Falsches Passwort!';
                    errorDiv.style.display = 'block';
                    setTimeout(() => errorDiv.style.display = 'none', 3000);
                }
            } catch (error) {
                console.error('Admin login error:', error);
                errorDiv.textContent = 'Verbindungsfehler - versuchen Sie es sp√§ter erneut';
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 3000);
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Anmelden';
                document.getElementById('adminPassword').value = '';
            }
        });
        
        // Enter-Taste f√ºr Login
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('adminLogin').click();
            }
        });
        
        // Admin-Daten laden
        function loadAdminData() {
            // Simulierte Daten (in Realit√§t w√ºrden diese vom Server kommen)
            document.getElementById('uptime').textContent = '4 Tage, 12 Stunden';
            document.getElementById('visitorsToday').textContent = '142';
            document.getElementById('activeSessions').textContent = '23';
            document.getElementById('spotifyLogins').textContent = '89';
            document.getElementById('eventsCreated').textContent = '34';
            document.getElementById('songRequests').textContent = '267';
            document.getElementById('errorCount').textContent = '12';
            
            updateStatusHistory();
        }
        
        // Status-Verlauf aktualisieren
        function updateStatusHistory() {
            const historyDiv = document.getElementById('statusHistory');
            if (statusHistory.length === 0) {
                historyDiv.textContent = 'Keine Verlaufsdaten verf√ºgbar';
            } else {
                historyDiv.innerHTML = statusHistory.slice(-5).map(entry => 
                    `${entry.time}: ${entry.status} (${entry.responseTime}ms)`
                ).join('<br>');
            }
        }
        
        // Wartungs-Tools
        document.getElementById('clearCache').addEventListener('click', async function() {
            const result = document.getElementById('maintenanceResult');
            result.style.display = 'block';
            result.textContent = 'Cache wird geleert...\n';
            
            try {
                // Backend-Cache leeren
                const response = await fetch('https://novel-willyt-veqro-a29cd625.koyeb.app/admin/cache/clear', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken')
                    }
                });
                
                if (response.ok) {
                    result.textContent += '‚úÖ Server-Cache geleert\n';
                } else {
                    result.textContent += '‚ùå Server-Cache Fehler\n';
                }
            } catch (error) {
                result.textContent += '‚ùå Server-Cache nicht erreichbar\n';
            }
            
            // Browser-Cache leeren
            try {
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    result.textContent += '‚úÖ Browser-Cache geleert\n';
                }
            } catch (error) {
                result.textContent += '‚ö†Ô∏è Browser-Cache teilweise geleert\n';
            }
            
            result.textContent += '‚úÖ Fertig!';
        });
        
        document.getElementById('testAllEndpoints').addEventListener('click', async function() {
            const result = document.getElementById('maintenanceResult');
            result.style.display = 'block';
            result.textContent = 'Teste alle Endpunkte...\n';
            
            const endpoints = [
                { path: '/auth/status', name: 'Auth Status' },
                { path: '/api/events', name: 'Events API' },
                { path: '/login', name: 'Login Endpoint' },
                { path: '/spotify/me', name: 'Spotify User' },
                { path: '/admin/health', name: 'System Health' }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const startTime = performance.now();
                    const response = await fetch(`https://novel-willyt-veqro-a29cd625.koyeb.app${endpoint.path}`, {
                        credentials: 'include',
                        headers: {
                            'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken')
                        }
                    });
                    const endTime = performance.now();
                    const latency = Math.round(endTime - startTime);
                    
                    const statusIcon = response.ok ? '‚úÖ' : '‚ùå';
                    result.textContent += `${statusIcon} ${endpoint.name}: ${response.status} (${latency}ms)\n`;
                } catch (error) {
                    result.textContent += `‚ùå ${endpoint.name}: Verbindungsfehler\n`;
                }
            }
            result.textContent += '\nüèÅ Test abgeschlossen!';
        });
        
        document.getElementById('downloadLogs').addEventListener('click', async function() {
            let logData = `CueUp Debug Logs - ${new Date().toISOString()}\n\nStatus History:\n${statusHistory.map(e => `${e.time}: ${e.status} (${e.responseTime}ms)`).join('\n')}\n\n`;
            
            // Versuche auch Server-Logs hinzuzuf√ºgen
            try {
                const response = await fetch('https://novel-willyt-veqro-a29cd625.koyeb.app/admin/logs?limit=500', {
                    credentials: 'include',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken')
                    }
                });
                
                if (response.ok) {
                    const serverLogs = await response.json();
                    logData += 'Server Logs:\n' + serverLogs.logs.map(log => `${log.timestamp} [${log.level}] ${log.message}`).join('\n') + '\n\n';
                }
            } catch (error) {
                logData += 'Server Logs: Fehler beim Laden der Server-Logs\n\n';
            }
            
            logData += 'End of Logs';
            
            const blob = new Blob([logData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cueup-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        });
        
        // Server Logs anzeigen
        document.getElementById('viewServerLogs').addEventListener('click', function() {
            document.getElementById('loadLogs').click();
        });
        
        // Server Logs laden
        document.getElementById('loadLogs').addEventListener('click', async function() {
            const container = document.getElementById('serverLogsContainer');
            const level = document.getElementById('logLevel').value;
            const limit = document.getElementById('logLimit').value || 100;
            
            container.innerHTML = '<div style="color: #ff9800; text-align: center; padding: 20px;">üîÑ Lade Server-Logs...</div>';
            
            try {
                const response = await fetch(`https://novel-willyt-veqro-a29cd625.koyeb.app/admin/logs?level=${level}&limit=${limit}`, {
                    credentials: 'include',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken')
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.logs && data.logs.length > 0) {
                        container.innerHTML = data.logs.map(log => {
                            let colorClass = '#ddd';
                            switch(log.level) {
                                case 'error': colorClass = '#f44336'; break;
                                case 'warning': colorClass = '#ff9800'; break;
                                case 'info': colorClass = '#2196f3'; break;
                                case 'debug': colorClass = '#4caf50'; break;
                            }
                            return `<div style="margin-bottom: 5px; border-left: 3px solid ${colorClass}; padding-left: 10px;">
                                <span style="color: #888;">${log.timestamp}</span> 
                                <span style="color: ${colorClass}; font-weight: bold;">[${log.level.toUpperCase()}]</span> 
                                <span style="color: #ddd;">${log.message}</span>
                            </div>`;
                        }).join('');
                    } else {
                        container.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Keine Logs gefunden</div>';
                    }
                } else if (response.status === 401) {
                    container.innerHTML = '<div style="color: #f44336; text-align: center; padding: 20px;">‚ùå Authentifizierung fehlgeschlagen</div>';
                } else {
                    container.innerHTML = '<div style="color: #f44336; text-align: center; padding: 20px;">‚ùå Fehler beim Laden der Logs</div>';
                }
            } catch (error) {
                container.innerHTML = '<div style="color: #f44336; text-align: center; padding: 20px;">‚ùå Verbindungsfehler</div>';
            }
        });
        
        // Logs aktualisieren
        document.getElementById('refreshServerLogs').addEventListener('click', function() {
            document.getElementById('loadLogs').click();
        });
        
        // Status-Verlauf erweitern
        function addToStatusHistory(status, responseTime) {
            statusHistory.push({
                time: new Date().toLocaleTimeString('de-DE'),
                status: status,
                responseTime: responseTime
            });
            
            // Nur letzte 50 Eintr√§ge behalten
            if (statusHistory.length > 50) {
                statusHistory = statusHistory.slice(-50);
            }
            
            if (adminLoggedIn) {
                updateStatusHistory();
            }
        }
        
        // Quick Actions
        document.getElementById('restartServer').addEventListener('click', async function() {
            const result = document.getElementById('quickActionResult');
            result.style.display = 'block';
            
            if (!confirm('‚ö†Ô∏è Server wirklich neustarten? Dies kann 1-2 Minuten dauern.')) {
                result.textContent = 'Neustart abgebrochen';
                return;
            }
            
            result.textContent = 'üîÑ Server wird neugestartet...\n';
            
            try {
                const response = await fetch('https://novel-willyt-veqro-a29cd625.koyeb.app/admin/restart', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken')
                    }
                });
                
                if (response.ok) {
                    result.textContent += '‚úÖ Neustart-Signal gesendet\n‚è≥ Server startet neu (bitte warten...)';
                } else {
                    result.textContent += '‚ùå Neustart fehlgeschlagen';
                }
            } catch (error) {
                result.textContent += '‚ùå Verbindungsfehler beim Neustart';
            }
        });
        
        document.getElementById('backupData').addEventListener('click', async function() {
            const result = document.getElementById('quickActionResult');
            result.style.display = 'block';
            result.textContent = 'üíæ Erstelle Backup...\n';
            
            try {
                const response = await fetch('https://novel-willyt-veqro-a29cd625.koyeb.app/admin/backup', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken')
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    result.textContent += '‚úÖ Backup erstellt\n';
                    result.textContent += `üìÅ Backup-ID: ${data.backupId}\n`;
                    result.textContent += `üìä Gr√∂√üe: ${data.size || 'Unbekannt'}`;
                    
                    // Backup-Download anbieten
                    if (data.downloadUrl) {
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'test-button';
                        downloadBtn.textContent = 'Backup herunterladen';
                        downloadBtn.onclick = () => window.open(data.downloadUrl);
                        result.appendChild(downloadBtn);
                    }
                } else {
                    result.textContent += '‚ùå Backup fehlgeschlagen';
                }
            } catch (error) {
                result.textContent += '‚ùå Verbindungsfehler beim Backup';
            }
        });
        
        document.getElementById('viewErrors').addEventListener('click', async function() {
            const result = document.getElementById('quickActionResult');
            result.style.display = 'block';
            result.textContent = 'üîç Lade Fehlermeldungen...\n';
            
            try {
                const response = await fetch('https://novel-willyt-veqro-a29cd625.koyeb.app/admin/errors?limit=20', {
                    credentials: 'include',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken')
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.errors && data.errors.length > 0) {
                        result.textContent = `üö® ${data.errors.length} aktuelle Fehler:\n\n`;
                        data.errors.forEach((error, index) => {
                            result.textContent += `${index + 1}. [${error.timestamp}] ${error.message}\n`;
                            if (error.stack) {
                                result.textContent += `   Stack: ${error.stack.split('\n')[0]}\n`;
                            }
                            result.textContent += '\n';
                        });
                    } else {
                        result.textContent = '‚úÖ Keine aktuellen Fehler gefunden';
                    }
                } else {
                    result.textContent = '‚ùå Fehler beim Laden der Fehlermeldungen';
                }
            } catch (error) {
                result.textContent = '‚ùå Verbindungsfehler';
            }
        });
        
        document.getElementById('systemHealth').addEventListener('click', async function() {
            const result = document.getElementById('quickActionResult');
            result.style.display = 'block';
            result.textContent = 'üè• System-Health-Check l√§uft...\n';
            
            try {
                const response = await fetch('https://novel-willyt-veqro-a29cd625.koyeb.app/admin/health', {
                    credentials: 'include',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken')
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    result.textContent = 'üìä System-Status:\n\n';
                    result.textContent += `üñ•Ô∏è  CPU: ${data.cpu || 'N/A'}%\n`;
                    result.textContent += `üíæ RAM: ${data.memory || 'N/A'}%\n`;
                    result.textContent += `üíø Disk: ${data.disk || 'N/A'}%\n`;
                    result.textContent += `üåê Network: ${data.network || 'OK'}\n`;
                    result.textContent += `üóÑÔ∏è  Database: ${data.database || 'OK'}\n`;
                    result.textContent += `üéµ Spotify API: ${data.spotify || 'OK'}\n`;
                    result.textContent += `‚è±Ô∏è  Uptime: ${data.uptime || 'N/A'}\n`;
                } else {
                    result.textContent = '‚ùå Health-Check fehlgeschlagen';
                }
            } catch (error) {
                result.textContent = '‚ùå Verbindungsfehler beim Health-Check';
            }
        });

        // Admin-Daten laden (erweitert)
        function loadAdminData() {
            // Simulierte Daten (in Realit√§t w√ºrden diese vom Server kommen)
            document.getElementById('uptime').textContent = 'Wird geladen...';
            document.getElementById('visitorsToday').textContent = 'Wird geladen...';
            document.getElementById('activeSessions').textContent = 'Wird geladen...';
            document.getElementById('spotifyLogins').textContent = 'Wird geladen...';
            document.getElementById('eventsCreated').textContent = 'Wird geladen...';
            document.getElementById('songRequests').textContent = 'Wird geladen...';
            document.getElementById('errorCount').textContent = 'Wird geladen...';
            
            updateStatusHistory();
            loadRealAdminStats();
        }
        
        // Echte Admin-Statistiken laden
        async function loadRealAdminStats() {
            try {
                const response = await fetch('https://novel-willyt-veqro-a29cd625.koyeb.app/admin/stats', {
                    credentials: 'include',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('adminToken')
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('uptime').textContent = stats.uptime || 'N/A';
                    document.getElementById('visitorsToday').textContent = stats.visitorsToday || '0';
                    document.getElementById('activeSessions').textContent = stats.activeSessions || '0';
                    document.getElementById('spotifyLogins').textContent = stats.spotifyLogins || '0';
                    document.getElementById('eventsCreated').textContent = stats.eventsCreated || '0';
                    document.getElementById('songRequests').textContent = stats.songRequests || '0';
                    document.getElementById('errorCount').textContent = stats.errorCount || '0';
                } else {
                    // Fallback auf Dummy-Daten
                    document.getElementById('uptime').textContent = '4 Tage, 12 Stunden';
                    document.getElementById('visitorsToday').textContent = '142';
                    document.getElementById('activeSessions').textContent = '23';
                    document.getElementById('spotifyLogins').textContent = '89';
                    document.getElementById('eventsCreated').textContent = '34';
                    document.getElementById('songRequests').textContent = '267';
                    document.getElementById('errorCount').textContent = '12';
                }
            } catch (error) {
                // Fallback auf Dummy-Daten
                document.getElementById('uptime').textContent = 'Unbekannt';
                document.getElementById('visitorsToday').textContent = '--';
                document.getElementById('activeSessions').textContent = '--';
                document.getElementById('spotifyLogins').textContent = '--';
                document.getElementById('eventsCreated').textContent = '--';
                document.getElementById('songRequests').textContent = '--';
                document.getElementById('errorCount').textContent = '--';
            }
        }

        // Automatischer Check beim Laden der Seite
        window.addEventListener('DOMContentLoaded', function() {
            // Sofort Standard-Men√º anzeigen
            showDefaultMenu();
            
            // Navigation aktualisieren
            setTimeout(updateNavigation, 100);
            
            // Verbindung pr√ºfen
            document.getElementById('checkConnection').click();
            
            // Auto-Refresh alle 30 Sekunden
            setInterval(function() {
                document.getElementById('checkConnection').click();
            }, 30000);
        });
    </script>
</body>
</html>