<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safari iOS Debug - CueUp</title>
    <link rel="stylesheet" href="startpage.css">
    <script src="config.js"></script>
    <style>
        .debug-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
            color: white;
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }
        .debug-info {
            font-family: monospace;
            font-size: 12px;
            background: #333;
            padding: 10px;
            border-radius: 3px;
            margin: 5px 0;
            white-space: pre-wrap;
        }
        button {
            background: #aa00ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: rgba(0,255,0,0.2); }
        .error { background: rgba(255,0,0,0.2); }
        .warning { background: rgba(255,255,0,0.2); }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>üçé Safari iOS Debug Tool</h1>
        
        <div class="debug-section">
            <h3>Browser Information</h3>
            <div id="browserInfo" class="debug-info"></div>
        </div>
        
        <div class="debug-section">
            <h3>Storage Test</h3>
            <button onclick="testStorage()">Storage Testen</button>
            <div id="storageResults" class="debug-info"></div>
        </div>
        
        <div class="debug-section">
            <h3>Cookie Test</h3>
            <button onclick="testCookies()">Cookies Testen</button>
            <div id="cookieResults" class="debug-info"></div>
        </div>
        
        <div class="debug-section">
            <h3>Auth Status Test</h3>
            <button onclick="testAuth()">Auth-Status Pr√ºfen</button>
            <div id="authResults" class="debug-info"></div>
        </div>
        
        <div class="debug-section">
            <h3>Session Recovery Test</h3>
            <button onclick="forceAuthCheck()">Session forcieren</button>
            <button onclick="clearAllData()">Alles l√∂schen</button>
            <div id="sessionResults" class="debug-info"></div>
        </div>
        
        <div class="debug-section">
            <h3>Spotify Login (Direct)</h3>
            <button onclick="spotifyLogin()">Spotify Login Starten</button>
            <div id="spotifyResults" class="debug-info"></div>
        </div>
    </div>

    <script>
        // Browser-Info sammeln
        function getBrowserInfo() {
            const ua = navigator.userAgent;
            const info = {
                userAgent: ua,
                isSafari: /^((?!chrome|android).)*safari/i.test(ua),
                isIOS: /iPad|iPhone|iPod/.test(ua),
                safariVersion: ua.match(/Version\/(\d+\.\d+)/) ? ua.match(/Version\/(\d+\.\d+)/)[1] : 'unknown',
                localStorage: typeof Storage !== "undefined",
                sessionStorage: typeof sessionStorage !== "undefined",
                cookies: navigator.cookieEnabled,
                platform: navigator.platform,
                language: navigator.language,
                url: window.location.href,
                referrer: document.referrer
            };
            return info;
        }
        
        // Storage-Funktionalit√§t testen
        function testStorage() {
            const results = [];
            const testData = { test: 'value', time: Date.now() };
            
            // localStorage Test
            try {
                localStorage.setItem('safari_test', JSON.stringify(testData));
                const retrieved = localStorage.getItem('safari_test');
                results.push('‚úÖ localStorage: ' + (retrieved ? 'OK' : 'FAILED'));
                localStorage.removeItem('safari_test');
            } catch (e) {
                results.push('‚ùå localStorage: ' + e.name);
            }
            
            // sessionStorage Test  
            try {
                sessionStorage.setItem('safari_test', JSON.stringify(testData));
                const retrieved = sessionStorage.getItem('safari_test');
                results.push('‚úÖ sessionStorage: ' + (retrieved ? 'OK' : 'FAILED'));
                sessionStorage.removeItem('safari_test');
            } catch (e) {
                results.push('‚ùå sessionStorage: ' + e.name);
            }
            
            document.getElementById('storageResults').textContent = results.join('\n');
        }
        
        // Cookie-Test
        function testCookies() {
            const results = [];
            
            try {
                // Cookie setzen
                document.cookie = 'safari_test=testvalue; path=/; max-age=60';
                
                // Cookie lesen
                const cookies = document.cookie.split(';');
                const testCookie = cookies.find(c => c.trim().startsWith('safari_test='));
                
                if (testCookie) {
                    results.push('‚úÖ Cookie schreiben/lesen: OK');
                    // Cookie l√∂schen
                    document.cookie = 'safari_test=; path=/; max-age=0';
                } else {
                    results.push('‚ùå Cookie lesen fehlgeschlagen');
                }
            } catch (e) {
                results.push('‚ùå Cookie Test: ' + e.name);
            }
            
            document.getElementById('cookieResults').textContent = results.join('\n');
        }
        
        // Auth-Status testen
        async function testAuth() {
            const results = [];
            const authUrl = window.CONFIG?.BACKEND_URL + '/auth/status' || 'https://cueup-project.onrender.com/auth/status';
            
            try {
                results.push('üîç Auth-Check zu: ' + authUrl);
                
                const response = await fetch(authUrl, {
                    method: 'GET',
                    credentials: 'include',
                    cache: 'no-cache'
                });
                
                results.push('üì° Response Status: ' + response.status);
                results.push('üì° Response Headers: ' + JSON.stringify([...response.headers.entries()]));
                
                if (response.ok) {
                    const data = await response.json();
                    results.push('‚úÖ Auth Response: ' + JSON.stringify(data, null, 2));
                } else {
                    const text = await response.text();
                    results.push('‚ùå Auth Error: ' + text);
                }
                
            } catch (e) {
                results.push('‚ùå Auth Request Failed: ' + e.name + ' - ' + e.message);
            }
            
            document.getElementById('authResults').textContent = results.join('\n');
        }
        
        // Session forcieren
        async function forceAuthCheck() {
            const results = [];
            
            try {
                const authUrl = window.CONFIG?.BACKEND_URL + '/auth/status' || 'https://cueup-project.onrender.com/auth/status';
                
                // Mehrfache Versuche
                for (let i = 1; i <= 3; i++) {
                    results.push(`\n--- Versuch ${i} ---`);
                    
                    const response = await fetch(authUrl, {
                        method: 'GET',
                        credentials: 'include',
                        cache: 'no-cache',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Accept': 'application/json'
                        }
                    });
                    
                    results.push('Status: ' + response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.isAuthenticated) {
                            results.push('‚úÖ AUTHENTICATED: ' + data.spotifyUsername);
                            
                            // Session speichern (mehrere Methoden)
                            const session = {
                                user: {
                                    spotifyUsername: data.spotifyUsername,
                                    spotifyConnected: true,
                                    isAuthenticated: true
                                },
                                expires: Date.now() + (30 * 24 * 60 * 60 * 1000),
                                created: Date.now()
                            };
                            
                            // localStorage
                            try {
                                localStorage.setItem('cueup_session', JSON.stringify(session));
                                results.push('‚úÖ localStorage gespeichert');
                            } catch (e) {
                                results.push('‚ùå localStorage: ' + e.name);
                            }
                            
                            // sessionStorage
                            try {
                                sessionStorage.setItem('cueup_session_safari', JSON.stringify(session));
                                results.push('‚úÖ sessionStorage gespeichert');
                            } catch (e) {
                                results.push('‚ùå sessionStorage: ' + e.name);
                            }
                            
                            // Cookie
                            try {
                                const cookieData = btoa(JSON.stringify({user: data.spotifyUsername, auth: true}));
                                document.cookie = `cueup_auth=${cookieData}; path=/; max-age=2592000`;
                                results.push('‚úÖ Cookie gespeichert');
                            } catch (e) {
                                results.push('‚ùå Cookie: ' + e.name);
                            }
                            
                            break;
                        } else {
                            results.push('‚ùå Not authenticated');
                        }
                    }
                    
                    if (i < 3) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
            } catch (e) {
                results.push('‚ùå Force Auth Failed: ' + e.message);
            }
            
            document.getElementById('sessionResults').textContent = results.join('\n');
        }
        
        // Alles l√∂schen
        function clearAllData() {
            const keys = ['cueup_session', 'cueup_session_safari', 'cueup_session_ios', 'spotify_session_backup'];
            
            keys.forEach(key => {
                try {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                } catch (e) {
                    console.warn('Clear failed for', key);
                }
            });
            
            // Cookies l√∂schen
            document.cookie = 'cueup_auth=; path=/; max-age=0';
            
            document.getElementById('sessionResults').textContent = 'üßπ Alle Daten gel√∂scht';
        }
        
        // Spotify Login
        function spotifyLogin() {
            const loginUrl = (window.CONFIG?.BACKEND_URL || 'https://cueup-project.onrender.com') + '/login';
            document.getElementById('spotifyResults').textContent = 'üéµ Weiterleitung zu: ' + loginUrl;
            window.location.href = loginUrl;
        }
        
        // Initial Info laden
        document.addEventListener('DOMContentLoaded', () => {
            const info = getBrowserInfo();
            document.getElementById('browserInfo').textContent = JSON.stringify(info, null, 2);
            
            // URL-Parameter pr√ºfen
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('code') || document.referrer.includes('spotify')) {
                document.getElementById('spotifyResults').textContent = 'üéµ Spotify-Callback erkannt!\nURL: ' + window.location.href + '\nReferrer: ' + document.referrer;
                
                // Auto-Auth nach Spotify
                setTimeout(() => {
                    forceAuthCheck();
                }, 1000);
            }
        });
    </script>
</body>
</html>